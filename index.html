<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶Ä Southeast Asia 2026 ‚Äî Dorian & Monica</title>
<meta name="description" content="62-day itinerary across Vietnam, Thailand & Malaysia.">
<meta property="og:title" content="Southeast Asia 2026 ‚Äî Dorian & Monica">
<meta property="og:description" content="62 days ¬∑ 3 countries ¬∑ 15 cities ¬∑ Oct‚ÄìDec 2026">
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width: 100%; height: 100%; font-family: 'Inter', system-ui, sans-serif; overflow: hidden; background: #0a0a1e; }
  #map { width: 100%; height: 100%; }

  .title-box {
    position: absolute; top: 12px; left: 50%; transform: translateX(-50%); z-index: 1000;
    background: linear-gradient(135deg, rgba(10,10,30,0.94), rgba(20,20,50,0.92));
    backdrop-filter: blur(12px); padding: 12px 28px; border-radius: 14px;
    text-align: center; border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4); pointer-events: none; max-width: 90vw;
  }
  .title-box h1 { font-size: 20px; color: #fff; font-weight: 800; letter-spacing: -0.5px; }
  .title-box .sub { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px; }

  .stats-box {
    position: absolute; top: 12px; right: 12px; z-index: 1000;
    background: linear-gradient(135deg, rgba(10,10,30,0.94), rgba(20,20,50,0.92));
    backdrop-filter: blur(12px); padding: 12px 16px; border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  .stat { text-align: center; margin-bottom: 8px; }
  .stat:last-child { margin-bottom: 0; }
  .stat-num { font-size: 20px; font-weight: 800; color: #fff; line-height: 1; }
  .stat-label { font-size: 8px; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

  .legend-box {
    position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); z-index: 1000;
    background: linear-gradient(135deg, rgba(10,10,30,0.94), rgba(20,20,50,0.92));
    backdrop-filter: blur(12px); padding: 8px 20px; border-radius: 10px;
    display: flex; gap: 16px; align-items: center; flex-wrap: wrap; justify-content: center;
    border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 95vw;
  }
  .leg { display: flex; align-items: center; gap: 5px; font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 500; white-space: nowrap; }
  .leg-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .leg-line { width: 18px; height: 3px; border-radius: 2px; flex-shrink: 0; }
  .leg-dash { width: 18px; height: 0; border-top: 2px dashed rgba(255,255,255,0.4); flex-shrink: 0; }

  .sidebar {
    position: absolute; top: 0; left: 0; bottom: 0; width: 380px; z-index: 1001;
    background: linear-gradient(180deg, rgba(10,10,30,0.97), rgba(15,15,40,0.97));
    backdrop-filter: blur(16px); overflow-y: auto; transform: translateX(-100%);
    transition: transform 0.3s ease; border-right: 1px solid rgba(255,255,255,0.06);
    scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.15) transparent;
  }
  .sidebar.open { transform: translateX(0); }
  .sidebar-header {
    position: sticky; top: 0; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
    background: rgba(10,10,30,0.95); border-bottom: 1px solid rgba(255,255,255,0.06); z-index: 1;
  }
  .sidebar-header h2 { font-size: 15px; color: #fff; font-weight: 700; }
  .sidebar-close { background: none; border: none; color: rgba(255,255,255,0.5); font-size: 22px; cursor: pointer; }
  .sidebar-close:hover { color: #fff; }

  .stop-item {
    padding: 10px 20px; display: flex; align-items: flex-start; gap: 12px;
    cursor: pointer; transition: background 0.15s;
  }
  .stop-item:hover { background: rgba(255,255,255,0.04); }
  .stop-item.active { background: rgba(255,255,255,0.08); }
  .stop-item.excursion { opacity: 0.75; }
  .stop-num {
    width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 800; color: #fff; flex-shrink: 0; margin-top: 2px;
    box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
  }
  .stop-num.exc { width: 22px; height: 22px; font-size: 10px; border: 2px dashed rgba(255,255,255,0.3); box-shadow: none; }
  .stop-details { flex: 1; min-width: 0; }
  .stop-name { font-size: 13px; font-weight: 600; color: #fff; }
  .stop-meta { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 1px; }
  .stop-note { font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 2px; font-style: italic; }

  .transport-row {
    display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
    padding: 5px 20px 5px 30px; position: relative;
    border-left: 2px dashed rgba(255,255,255,0.08); margin-left: 33px;
  }
  .t-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 500;
    background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.55);
    border: 1px solid rgba(255,255,255,0.06);
  }
  .t-badge .t-icon { font-size: 11px; }
  .t-badge .t-time { color: rgba(255,255,255,0.8); font-weight: 700; }
  .t-badge .t-cost { color: rgba(255,255,255,0.35); }
  .t-badge.return { border-style: dashed; opacity: 0.7; }

  .country-divider {
    padding: 8px 20px; font-size: 11px; font-weight: 700; letter-spacing: 1px;
    text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.06);
  }

  .sidebar-toggle {
    position: absolute; top: 80px; left: 12px; z-index: 1000;
    background: linear-gradient(135deg, rgba(10,10,30,0.94), rgba(20,20,50,0.92));
    backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08);
    color: #fff; width: 40px; height: 40px; border-radius: 10px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 18px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3); transition: opacity 0.3s;
  }
  .sidebar-toggle:hover { background: rgba(30,30,60,0.95); }
  .sidebar.open ~ .sidebar-toggle { opacity: 0; pointer-events: none; }

  /* TextPath handles route labels now ‚Äî text follows the polyline */

  .marker-pin {
    width: 30px; height: 30px; border-radius: 50%; display: flex;
    align-items: center; justify-content: center; font-size: 12px;
    font-weight: 800; color: #fff; cursor: pointer;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.2), 0 4px 12px rgba(0,0,0,0.5);
  }
  .marker-pin.small { width: 24px; height: 24px; font-size: 10px; }
  .marker-pin.large { width: 36px; height: 36px; font-size: 14px; }
  .marker-pin.excursion { width: 22px; height: 22px; font-size: 9px; border: 2px dashed rgba(255,255,255,0.4); box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
  .marker-pin.vietnam { background: linear-gradient(135deg, #e74c3c, #c0392b); }
  .marker-pin.thailand { background: linear-gradient(135deg, #f39c12, #e67e22); }
  .marker-pin.malaysia { background: linear-gradient(135deg, #3498db, #2980b9); }
  .marker-pin.planb { background: linear-gradient(135deg, #9b59b6, #8e44ad); border: 2px dashed rgba(255,255,255,0.6); }

  .city-tooltip-planb {
    padding: 3px 8px !important; border-radius: 5px !important; font-size: 11px !important;
    font-weight: 600 !important; white-space: nowrap !important; color: #d4aaff !important;
    background: rgba(30,10,50,0.9) !important; border: 1px dashed rgba(155,89,182,0.5) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important; pointer-events: none !important;
    font-family: 'Inter', system-ui, sans-serif !important; font-style: italic !important;
  }
  .city-tooltip-planb::before { display: none !important; }

  .city-tooltip {
    padding: 3px 8px !important; border-radius: 5px !important; font-size: 11px !important;
    font-weight: 600 !important; white-space: nowrap !important; color: #fff !important;
    background: rgba(10,10,30,0.9) !important; border: 1px solid rgba(255,255,255,0.12) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important; pointer-events: none !important;
    font-family: 'Inter', system-ui, sans-serif !important;
  }
  .city-tooltip::before { display: none !important; /* hide the default arrow */ }

  .custom-popup .leaflet-popup-content-wrapper {
    background: linear-gradient(135deg, rgba(10,10,30,0.96), rgba(20,20,50,0.94)) !important;
    color: #fff !important; border-radius: 12px !important; padding: 0 !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5) !important;
    font-family: 'Inter', system-ui, sans-serif !important;
  }
  .custom-popup .leaflet-popup-content { margin: 14px 18px !important; min-width: 200px; }
  .custom-popup .leaflet-popup-tip { background: rgba(10,10,30,0.96) !important; }
  .custom-popup .leaflet-popup-close-button { color: rgba(255,255,255,0.4) !important; font-size: 18px !important; }
  .pop-title { font-size: 16px; font-weight: 700; }
  .pop-dates { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 4px; }
  .pop-highlights { font-size: 11px; color: rgba(255,255,255,0.45); margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.08); }
  .pop-food { font-size: 11px; color: rgba(255,255,255,0.45); margin-top: 4px; }
  .pop-note { font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 4px; font-style: italic; }
  .leaflet-control-attribution { display: none !important; }

  @media (max-width: 600px) {
    .title-box { padding: 8px 16px; }
    .title-box h1 { font-size: 16px; }
    .stats-box { display: none; }
    .sidebar { width: 300px; }
    .legend-box { gap: 10px; padding: 6px 14px; }
  }
</style>
</head>
<body>

<div class="title-box">
  <h1>ü¶Ä Southeast Asia 2026</h1>
  <div class="sub">Oct 15 ‚Üí Dec 15 ¬∑ Dorian & Monica</div>
</div>

<div class="stats-box">
  <div class="stat"><div class="stat-num">62</div><div class="stat-label">Days</div></div>
  <div class="stat"><div class="stat-num">3</div><div class="stat-label">Countries</div></div>
  <div class="stat"><div class="stat-num">18</div><div class="stat-label">Stops</div></div>
</div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>üìç Itinerary</h2>
    <button class="sidebar-close" onclick="toggleSidebar()">‚úï</button>
  </div>
  <div id="sidebar-content"></div>
</div>
<button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>

<div class="legend-box">
  <div class="leg"><span class="leg-dot" style="background:linear-gradient(135deg,#e74c3c,#c0392b);"></span> üáªüá≥ Vietnam ¬∑ 22d</div>
  <div class="leg"><span class="leg-dot" style="background:linear-gradient(135deg,#f39c12,#e67e22);"></span> üáπüá≠ Thailand ¬∑ 19d</div>
  <div class="leg"><span class="leg-dot" style="background:linear-gradient(135deg,#3498db,#2980b9);"></span> üá≤üáæ Malaysia ¬∑ 20d</div>
  <div class="leg"><span class="leg-line" style="background:linear-gradient(90deg,#e74c3c,#f39c12);"></span> Ground</div>
  <div class="leg"><span class="leg-dash"></span> ‚úàÔ∏è Flight</div>
  <div class="leg"><span style="width:14px;height:14px;border:2px dashed rgba(255,255,255,0.4);border-radius:50%;display:inline-block;"></span> Excursion</div>
  <div class="leg"><span class="leg-dot" style="background:linear-gradient(135deg,#9b59b6,#8e44ad);border:1px dashed rgba(255,255,255,0.5);"></span> üåÄ Plan B</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-textpath@1.2.3/leaflet.textpath.js"></script>
<script>
// Stops: excursion = round-trip from base city, baseIdx = which stop they return to
const stops = [
  { id:0, name:"Hanoi", emoji:"üèôÔ∏è", lat:21.0285, lng:105.8542, country:"vietnam", flag:"üáªüá≥", days:"D1‚ÄìD4", dates:"Oct 15‚Äì18", dur:"4 days", dnum:4, note:"Base for 8 days (D1‚ÄìD9). Hotel holds luggage.", highlights:"Old Quarter, Hoa Lo Prison, Street Food Tour, Long Bien Bridge", food:"Pho Thin, Bun Cha, Egg Coffee, Cha Ca" },
  { id:1, name:"Ha Long Bay", emoji:"üåä", lat:20.91, lng:107.18, country:"vietnam", flag:"üáªüá≥", days:"D5‚ÄìD6", dates:"Oct 19‚Äì20", dur:"2 days", dnum:2, excursion:true, baseIdx:0, note:"Round trip from Hanoi. Lan Ha Bay cruise.", highlights:"2D/1N cruise, kayaking, Dark & Light Cave" },
  { id:2, name:"Ninh Binh", emoji:"üèûÔ∏è", lat:20.25, lng:105.97, country:"vietnam", flag:"üáªüá≥", days:"D7‚ÄìD8", dates:"Oct 21‚Äì22", dur:"2 days", dnum:2, excursion:true, baseIdx:0, note:"Round trip from Hanoi. 1 night in Tam Coc.", highlights:"Trang An UNESCO boat ride, Mua Cave, rice paddies by bike" },
  { id:3, name:"Da Nang", emoji:"‚úàÔ∏è", lat:16.054, lng:108.202, country:"vietnam", flag:"üáªüá≥", days:"D9,D16", dates:"Oct 23, Oct 30", dur:"transit", dnum:0, transit:true, note:"Hub de transit ‚Äî arriv√©e train de nuit, d√©part vol Saigon.", highlights:"Marble Mountains (en route)" },
  { id:4, name:"Hoi An", emoji:"üèÆ", lat:15.88, lng:108.34, country:"vietnam", flag:"üáªüá≥", days:"D10‚ÄìD13", dates:"Oct 24‚Äì27", dur:"4 days", dnum:4, note:"‚ö†Ô∏è Typhoon risk in October ‚Äî check weather D-7.", highlights:"Ancient Town, Tra Que cooking class, lantern boats, tailors, basket boats", food:"Cao Lau, Banh Mi Phuong, Mi Quang, White Rose" },
  { id:5, name:"Hu·∫ø", emoji:"üèØ", lat:16.4637, lng:107.5909, country:"vietnam", flag:"üáªüá≥", days:"D14‚ÄìD15", dates:"Oct 28‚Äì29", dur:"2 days", dnum:2, highlights:"Imperial City, Khai Dinh Tomb, Dong Ba Market, Thien Mu Pagoda", food:"Bun Bo Hue, Banh Khoai, Banh Beo, Bun Rieu" },
  { id:6, name:"ƒê√† L·∫°t üåÄ", emoji:"‚õ∞Ô∏è", lat:11.9404, lng:108.4583, country:"vietnam", flag:"üáªüá≥", days:"D9‚ÄìD14", dates:"Oct 23‚Äì28", dur:"4 days + transit", dnum:4, planb:true, note:"üåÄ PLAN B TYPHON ‚Äî remplace Hoi An + Hu·∫ø si typhon sur le Centre.", highlights:"Canyoning, coffee plantations, night market, Crazy House, waterfalls", food:"B√°nh tr√°ng n∆∞·ªõng, Nem n∆∞·ªõng, Kem b∆°, C√† ph√™ ch·ªìn" },
  { id:7, name:"Ho Chi Minh City", emoji:"üåÜ", lat:10.82, lng:106.63, country:"vietnam", flag:"üáªüá≥", days:"D16‚ÄìD20", dates:"Oct 30 ‚Äì Nov 3", dur:"5 days", dnum:5, highlights:"Cu Chi Tunnels, War Remnants Museum, District 4 food, A O Show", food:"Banh Mi Huynh Hoa, Com Tam, Bo Ne, Pho Hoa" },
  { id:8, name:"Can Tho", emoji:"üö£", lat:10.05, lng:105.75, country:"vietnam", flag:"üáªüá≥", days:"D21‚ÄìD22", dates:"Nov 4‚Äì5", dur:"2 days", dnum:2, excursion:true, baseIdx:7, note:"Round trip from HCMC.", highlights:"Cai Rang & Phong Dien floating markets, homestay" },
  { id:9, name:"Bangkok", emoji:"üèôÔ∏è", lat:13.76, lng:100.50, country:"thailand", flag:"üáπüá≠", days:"D23‚ÄìD26", dates:"Nov 6‚Äì9", dur:"4 days", dnum:4, highlights:"Grand Palace, Chinatown, Chatuchak, Muay Thai", food:"Pad Thai, Som Tam, Mango Sticky Rice" },
  { id:10, name:"Chiang Mai", emoji:"‚õ∞Ô∏è", lat:18.79, lng:98.99, country:"thailand", flag:"üáπüá≠", days:"D28‚ÄìD33", dates:"Nov 11‚Äì16", dur:"6 days", dnum:6, highlights:"Elephant Nature Park, temples, cooking class, markets" },
  { id:11, name:"Krabi", emoji:"‚úàÔ∏è", lat:8.0986, lng:98.9862, country:"thailand", flag:"üáπüá≠", days:"D34", dates:"Nov 17", dur:"transit", dnum:0, transit:true, note:"Transit ‚Äî a√©roport pour Koh Lanta." },
  { id:12, name:"Koh Lanta", emoji:"üèñÔ∏è", lat:7.65, lng:99.04, country:"thailand", flag:"üáπüá≠", days:"D35‚ÄìD40", dates:"Nov 18‚Äì23", dur:"6 days", dnum:6, highlights:"Beaches, Old Town, snorkeling, pure relaxation" },
  { id:13, name:"Langkawi", emoji:"üèùÔ∏è", lat:6.35, lng:99.80, country:"malaysia", flag:"üá≤üáæ", days:"D43‚ÄìD46", dates:"Nov 26‚Äì29", dur:"4 days", dnum:4, highlights:"Sky Bridge, beaches, mangroves, duty-free" },
  { id:14, name:"Penang", emoji:"üé®", lat:5.42, lng:100.33, country:"malaysia", flag:"üá≤üáæ", days:"D47‚ÄìD50", dates:"Nov 30 ‚Äì Dec 3", dur:"4 days", dnum:4, highlights:"George Town street art, temples, food capital", food:"Char Kway Teow, Laksa, Cendol" },
  { id:15, name:"Cameron Highlands", emoji:"üåø", lat:4.47, lng:101.38, country:"malaysia", flag:"üá≤üáæ", days:"D51‚ÄìD52", dates:"Dec 4‚Äì5", dur:"2 days", dnum:2, highlights:"Tea plantations, Mossy Forest, strawberry farms" },
  { id:16, name:"Kuala Lumpur", emoji:"üèôÔ∏è", lat:3.14, lng:101.69, country:"malaysia", flag:"üá≤üáæ", days:"D53‚ÄìD56", dates:"Dec 6‚Äì9", dur:"4 days", dnum:4, highlights:"Petronas, Batu Caves, Jalan Alor food street", food:"Nasi Lemak, Roti Canai, Satay" },
  { id:17, name:"Melaka", emoji:"üèõÔ∏è", lat:2.19, lng:102.25, country:"malaysia", flag:"üá≤üáæ", days:"D57‚ÄìD58", dates:"Dec 10‚Äì11", dur:"2 days", dnum:2, excursion:true, baseIdx:16, note:"Round trip from KL. 1 night.", highlights:"Jonker Street, colonial history, river cruise" },
  { id:18, name:"KL ‚Äî Departure", emoji:"‚úàÔ∏è", lat:3.14, lng:101.69, country:"malaysia", flag:"üá≤üáæ", days:"D59‚ÄìD62", dates:"Dec 12‚Äì15", dur:"4 days", dnum:4, highlights:"Rest, shopping, farewell meals" },
];

// Routes: actual transport between stops (reflecting real flow)
// Excursions show outbound + return, main routes show the onward journey
const routes = [
  // Hanoi ‚Üí Ha Long (excursion out)
  { from:0, to:1, segments:[{ icon:"üöê", mode:"Cruise shuttle", time:"3h", cost:"included" }], flight:false, excursionOut:true },
  // Ha Long ‚Üí Hanoi (excursion return)
  { from:1, to:0, segments:[{ icon:"üöê", mode:"Return shuttle", time:"3h", cost:"included" }], flight:false, excursionReturn:true, label:"Return to Hanoi" },
  // Hanoi ‚Üí Ninh Binh (excursion out)
  { from:0, to:2, segments:[{ icon:"üöå", mode:"Bus", time:"2h", cost:"8‚Äì12‚Ç¨/pp" }], flight:false, excursionOut:true },
  // Ninh Binh ‚Üí Hanoi (excursion return)
  { from:2, to:0, segments:[{ icon:"üöå", mode:"Bus", time:"2h", cost:"8‚Äì12‚Ç¨/pp" }], flight:false, excursionReturn:true, label:"Return to Hanoi" },
  // Hanoi ‚Üí Da Nang (night train D9)
  { from:0, to:3, segments:[{ icon:"üöÇ", mode:"Night train S20", time:"14‚Äì16h", cost:"~25‚Ç¨/pp" }], flight:false },
  // Da Nang ‚Üí Hoi An (Grab transfer)
  { from:3, to:4, segments:[{ icon:"üöó", mode:"Grab", time:"30min", cost:"~5‚Ç¨" }], flight:false },
  // Hoi An ‚Üí Hu·∫ø (minivan via Hai Van Pass)
  { from:4, to:5, segments:[{ icon:"üöê", mode:"Hai Van Pass", time:"3‚Äì4h", cost:"6‚Äì8‚Ç¨/pp" }], flight:false },
  // Hu·∫ø ‚Üí Da Nang (train back to airport)
  { from:5, to:3, segments:[{ icon:"üöÇ", mode:"Train", time:"2h30", cost:"~10‚Ç¨/pp" }], flight:false },
  // Da Nang ‚Üí HCMC (flight)
  { from:3, to:7, segments:[{ icon:"‚úàÔ∏è", mode:"Flight DAD‚ÜíSGN", time:"2h", cost:"50‚Ç¨/pp" }], flight:true },
  // --- PLAN B TYPHON: Hanoi ‚Üí Da Lat ‚Üí Saigon ---
  { from:0, to:6, segments:[{ icon:"‚úàÔ∏è", mode:"Flight HAN‚ÜíDLI", time:"2h", cost:"~40‚Ç¨/pp" }], flight:true, planb:true },
  { from:6, to:7, segments:[{ icon:"‚úàÔ∏è", mode:"Flight DLI‚ÜíSGN", time:"1h", cost:"~30‚Ç¨/pp" }], flight:true, planb:true },
  // --- END PLAN B ---
  // HCMC ‚Üí Can Tho (excursion out)
  { from:7, to:8, segments:[{ icon:"üöê", mode:"Bus/Van", time:"3‚Äì4h", cost:"10‚Äì15‚Ç¨/pp" }], flight:false, excursionOut:true },
  // Can Tho ‚Üí HCMC (excursion return)
  { from:8, to:7, segments:[{ icon:"üöê", mode:"Bus/Van", time:"3‚Äì4h", cost:"10‚Äì15‚Ç¨/pp" }], flight:false, excursionReturn:true, label:"Return to HCMC" },
  // HCMC ‚Üí Bangkok
  { from:7, to:9, segments:[{ icon:"‚úàÔ∏è", mode:"Flight", time:"1h30", cost:"60‚Ç¨/pp" }], flight:true },
  // Bangkok ‚Üí Chiang Mai
  { from:9, to:10, segments:[{ icon:"üöÇ", mode:"Night train", time:"12‚Äì14h", cost:"30‚Ç¨/pp" }], flight:false },
  // Chiang Mai ‚Üí Krabi (flight)
  { from:10, to:11, segments:[{ icon:"‚úàÔ∏è", mode:"Flight CNX‚ÜíKBV", time:"2h", cost:"~70‚Ç¨/pp" }], flight:true },
  // Krabi ‚Üí Koh Lanta (ferry)
  { from:11, to:12, segments:[{ icon:"üö¢", mode:"Ferry", time:"1h30", cost:"~15‚Ç¨/pp" }], flight:false },
  // Koh Lanta ‚Üí Langkawi (ferry via Koh Lipe, international crossing)
  { from:12, to:13, segments:[{ icon:"üö¢", mode:"Ferry via Koh Lipe", time:"5h30‚Äì6h30", cost:"~85‚Ç¨/pp" }], flight:false },
  // Langkawi ‚Üí Penang (ferry)
  { from:13, to:14, segments:[{ icon:"üö¢", mode:"Ferry", time:"2h45", cost:"15‚Ç¨/pp" }], flight:false },
  // Penang ‚Üí Cameron Highlands
  { from:14, to:15, segments:[{ icon:"üöå", mode:"Bus", time:"4‚Äì5h", cost:"10‚Äì15‚Ç¨/pp" }], flight:false },
  // Cameron ‚Üí KL
  { from:15, to:16, segments:[{ icon:"üöå", mode:"Bus", time:"4h", cost:"10‚Äì15‚Ç¨/pp" }], flight:false },
  // KL ‚Üí Melaka (excursion out)
  { from:16, to:17, segments:[{ icon:"üöå", mode:"Bus", time:"2h", cost:"10‚Ç¨/pp" }], flight:false, excursionOut:true },
  // Melaka ‚Üí KL (excursion return)
  { from:17, to:16, segments:[{ icon:"üöå", mode:"Bus", time:"2h", cost:"~10‚Ç¨/pp" }], flight:false, excursionReturn:true, label:"Return to KL" },
];

const colors = { vietnam:'#e74c3c', thailand:'#f39c12', malaysia:'#3498db' };
const colorsLight = { vietnam:'#ff6b6b', thailand:'#ffd93d', malaysia:'#6bcfff' };
const countryNames = { vietnam:'üáªüá≥ Vietnam', thailand:'üáπüá≠ Thailand', malaysia:'üá≤üáæ Malaysia' };

// Sidebar
function buildSidebar() {
  let html = '', lastCountry = '';
  // Ordered display (skip duplicate KL departure in sidebar, show inline)
  const displayOrder = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18];

  displayOrder.forEach(idx => {
    const s = stops[idx];
    if (idx === 18) return; // departure shown as note on KL

    if (s.country !== lastCountry) {
      html += `<div class="country-divider" style="color:${colors[s.country]};">${countryNames[s.country]}</div>`;
      lastCountry = s.country;
    }

    const isExc = s.excursion;
    const isPB = s.planb;
    const numBg = isPB ? 'background:linear-gradient(135deg,#9b59b6,#8e44ad);border:2px dashed rgba(255,255,255,0.4);' : `background:linear-gradient(135deg,${colors[s.country]},${colors[s.country]}cc);`;
    html += `<div class="stop-item ${isExc?'excursion':''}" data-idx="${idx}" onclick="flyTo(${idx})" ${isPB?'style="opacity:0.75;border-left:3px solid #9b59b6;"':''}>
      <div class="stop-num ${isExc?'exc':''}" style="${numBg}">${isPB?'üåÄ':idx+1}</div>
      <div class="stop-details">
        <div class="stop-name">${s.emoji} ${s.name} ${isExc?'<span style="font-size:9px;opacity:0.5;">‚Ü© excursion</span>':''}${isPB?'<span style="font-size:9px;color:#9b59b6;"> PLAN B</span>':''}</div>
        <div class="stop-meta">${s.dates} ¬∑ ${s.dur} (${s.days})</div>
        ${s.note?`<div class="stop-note">${s.note}</div>`:''}
      </div>
    </div>`;

    // Transport rows after this stop
    const outRoutes = routes.filter(r => r.from === idx && !r.excursionReturn);
    const retRoutes = routes.filter(r => r.from === idx && r.excursionReturn);

    if (outRoutes.length || retRoutes.length) {
      html += `<div class="transport-row">`;
      outRoutes.forEach(route => {
        route.segments.forEach(seg => {
          html += `<div class="t-badge"><span class="t-icon">${seg.icon}</span> ${seg.mode} <span class="t-time">${seg.time}</span> <span class="t-cost">¬∑ ${seg.cost}</span></div>`;
        });
      });
      retRoutes.forEach(route => {
        route.segments.forEach(seg => {
          html += `<div class="t-badge return"><span class="t-icon">‚Ü©</span> ${seg.mode} <span class="t-time">${seg.time}</span> <span class="t-cost">¬∑ ${seg.cost}</span></div>`;
        });
      });
      html += `</div>`;
    }
  });

  // Departure note
  html += `<div class="transport-row"><div class="t-badge"><span class="t-icon">‚úàÔ∏è</span> Int'l flight home <span class="t-cost">¬∑ ~450‚Ç¨/pp</span></div></div>`;

  document.getElementById('sidebar-content').innerHTML = html;
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function flyTo(idx) {
  const s = stops[idx];
  map.flyTo([s.lat,s.lng], 8, {duration:1.2});
  if(markersArr[idx]) markersArr[idx].openPopup();
  document.querySelectorAll('.stop-item').forEach(el=>el.classList.remove('active'));
  const el=document.querySelector(`.stop-item[data-idx="${idx}"]`);
  if(el){el.classList.add('active');el.scrollIntoView({behavior:'smooth',block:'nearest'});}
}

// Map
const map = L.map('map',{zoomControl:false,attributionControl:false}).setView([11.5,103],5);
L.control.zoom({position:'bottomright'}).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{subdomains:'abcd',maxZoom:19}).addTo(map);

function bezierCurve(from,to,n=40){
  const dist=Math.sqrt(Math.pow(to[0]-from[0],2)+Math.pow(to[1]-from[1],2));
  const offset=dist*0.35;const dx=to[1]-from[1],dy=to[0]-from[0],len=Math.sqrt(dx*dx+dy*dy)||1;
  const cpLat=(from[0]+to[0])/2+(dx/len)*offset,cpLng=(from[1]+to[1])/2-(dy/len)*offset;
  const pts=[];for(let i=0;i<=n;i++){const t=i/n;pts.push([(1-t)*(1-t)*from[0]+2*(1-t)*t*cpLat+t*t*to[0],(1-t)*(1-t)*from[1]+2*(1-t)*t*cpLng+t*t*to[1]]);}
  return pts;
}

// Draw routes with TextPath labels
routes.forEach(route=>{
  const fromS=stops[route.from],toS=stops[route.to];
  const from=[fromS.lat,fromS.lng],to=[toS.lat,toS.lng];
  const color=colors[toS.country]||colors[fromS.country];
  const colorL=colorsLight[toS.country]||colorsLight[fromS.country];
  const isReturn=route.excursionReturn;

  // Build text label
  const labelText = route.segments.map(s=>`${s.icon} ${s.time}`).join(' + ');

  const isPlanB = route.planb;
  const textAttrs = {fill: isPlanB ? '#d4aaff' : '#fff','font-size':'11','font-weight':'700','font-family':'Inter, system-ui, sans-serif','paint-order':'stroke','stroke':'rgba(10,10,30,0.85)','stroke-width':'4','stroke-linecap':'round','stroke-linejoin':'round'};

  if(route.flight){
    const curve=bezierCurve(from,to);
    if(isPlanB){
      // Plan B: purple dashed with glow
      L.polyline(curve,{color:'#9b59b6',weight:6,opacity:0.15,lineCap:'round'}).addTo(map);
      const flightLine=L.polyline(curve,{color:'#9b59b6',weight:2.5,dashArray:'6 8',opacity:0.6,lineCap:'round'}).addTo(map);
      if(!isReturn) flightLine.setText('üåÄ '+labelText,{repeat:false,center:true,offset:14,attributes:textAttrs});
    } else {
      L.polyline(curve,{color:colorL,weight:8,opacity:0.1,lineCap:'round'}).addTo(map);
      const flightLine=L.polyline(curve,{color:'rgba(255,255,255,0.55)',weight:2.5,dashArray:'8 6',opacity:0.65,lineCap:'round'}).addTo(map);
      if(!isReturn) flightLine.setText(labelText,{repeat:false,center:true,offset:14,attributes:textAttrs});
    }
  } else if(isReturn){
    // Return routes: no line drawn
  } else {
    if(isPlanB){
      L.polyline([from,to],{color:'#9b59b6',weight:4,opacity:0.12,lineCap:'round'}).addTo(map);
      const mainLine=L.polyline([from,to],{color:'#9b59b6',weight:2.5,dashArray:'6 8',opacity:0.6,lineCap:'round'}).addTo(map);
      const needFlip = from[1] > to[1];
      const textLine = needFlip ? L.polyline([to,from],{opacity:0}).addTo(map) : mainLine;
      textLine.setText('üåÄ '+labelText,{repeat:false,center:true,offset:12,attributes:textAttrs});
    } else {
      L.polyline([from,to],{color:colorL,weight:6,opacity:0.12,lineCap:'round'}).addTo(map);
      const mainLine=L.polyline([from,to],{color:color,weight:3,opacity:0.8,lineCap:'round'}).addTo(map);
      const needFlip = from[1] > to[1];
      const textLine = needFlip ? L.polyline([to,from],{opacity:0}).addTo(map) : mainLine;
      textLine.setText(labelText,{repeat:false,center:true,offset:12,attributes:textAttrs});
    }
  }
});

// Markers
const markersArr=[];
// Tooltip direction hints for dense areas (auto works for most)
const labelDir={0:'left',1:'right',2:'left',3:'right',4:'right',5:'left',6:'right',7:'left',8:'right',9:'left',10:'right',11:'right',12:'left',13:'right',14:'left',15:'right',16:'left',17:'right'};

stops.forEach((s,i)=>{
  if(i===18) return; // skip departure duplicate
  const isExc=s.excursion;
  const isTransit=s.transit;
  const isPlanB=s.planb;
  const sz=isTransit?'small':isPlanB?'':isExc?'excursion':s.dnum>=5?'large':s.dnum<=2?'small':'';
  const pinClass=isPlanB?'planb':s.country;
  const icon=L.divIcon({
    className:'',
    html:`<div class="marker-pin ${sz} ${pinClass}">${isPlanB?'üåÄ':i+1}</div>`,
    iconSize:isExc?[22,22]:sz==='large'?[36,36]:sz==='small'?[24,24]:[30,30],
    iconAnchor:isExc?[11,11]:sz==='large'?[18,18]:sz==='small'?[12,12]:[15,15]
  });

  const popupHtml=`
    <div class="pop-title">${s.emoji} ${s.name}</div>
    <div class="pop-dates">${s.flag} ${s.dates} ¬∑ ${s.dur} (${s.days})</div>
    ${s.note?`<div class="pop-note">${s.note}</div>`:''}
    ${s.highlights?`<div class="pop-highlights">üìç ${s.highlights}</div>`:''}
    ${s.food?`<div class="pop-food">üçú ${s.food}</div>`:''}
  `;
  const marker=L.marker([s.lat,s.lng],{icon}).addTo(map);
  marker.bindPopup(popupHtml,{className:'custom-popup',closeButton:true,maxWidth:280});
  marker.bindTooltip(s.name,{permanent:true,direction:labelDir[i]||'auto',className:isPlanB?'city-tooltip-planb':'city-tooltip',offset:[0,0]});
  markersArr.push(marker);
});

buildSidebar();
if(window.innerWidth>768) toggleSidebar();
</script>
</body>
</html>
